version: "3.9"

services:
  app:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: board-sapa-app
    working_dir: /var/www/html
    volumes:
      - ./laravel:/var/www/html
    environment:
      - APP_NAME=Board-SAPA-BBL
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=https://sapa-bbl.id
      - DB_CONNECTION=mysql
      - DB_HOST=sapabbl-application-1okzop-mysql-1
      - DB_PORT=3306
      - DB_DATABASE=sapa_db
      - DB_USERNAME=sapa_user
      - DB_PASSWORD=Usr@SapaBBL2026!Qw7
      - REDIS_HOST=board-sapa-redis
      - REDIS_PORT=6379
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
    depends_on:
      - redis
    networks:
      - sapa-network
      - dokploy-network

  nginx:
    image: nginx:1.27-alpine
    container_name: board-sapa-nginx
    volumes:
      - ./laravel:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app
    networks:
      - sapa-network
      - dokploy-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      # Service definition
      - "traefik.http.services.board-sapa.loadbalancer.server.port=80"
      # HTTPS Router - sapa-bbl.id (landing page)
      - "traefik.http.routers.board-sapa.rule=Host(`sapa-bbl.id`)"
      - "traefik.http.routers.board-sapa.entrypoints=websecure"
      - "traefik.http.routers.board-sapa.tls=true"
      - "traefik.http.routers.board-sapa.tls.certresolver=letsencrypt"
      - "traefik.http.routers.board-sapa.service=board-sapa"
      # HTTP Router with redirect
      - "traefik.http.routers.board-sapa-http.rule=Host(`sapa-bbl.id`)"
      - "traefik.http.routers.board-sapa-http.entrypoints=web"
      - "traefik.http.routers.board-sapa-http.middlewares=board-sapa-redirect-https"
      # Redirect middleware
      - "traefik.http.middlewares.board-sapa-redirect-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.board-sapa-redirect-https.redirectscheme.permanent=true"

  redis:
    image: redis:7-alpine
    container_name: board-sapa-redis
    networks:
      - sapa-network
    restart: unless-stopped

networks:
  sapa-network:
    external: true
    name: sapa-network
  dokploy-network:
    external: true
