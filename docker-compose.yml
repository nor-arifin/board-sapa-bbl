version: "3.9"

# Policy: Remove orphaned containers on startup to prevent conflicts
# This helps prevent "container name already in use" errors
services:
  app:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: board-sapa-app
    working_dir: /var/www/html
    volumes:
      - app-data:/var/www/html
    environment:
      - APP_NAME=${APP_NAME:-Board-SAPA-BBL}
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY=${APP_KEY:-base64:H9SP/nZQmcVAlbB/JXsZ0+OkUTF/rHHW09/kwHK6kUg=}
      - APP_URL=${APP_URL:-https://sapa-bbl.id}
      - APP_LOCALE=${APP_LOCALE:-id}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-sapabbl-application-fwunuy-mysql-1}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-sapa_db}
      - DB_USERNAME=${DB_USERNAME:-sapa_user}
      - DB_PASSWORD=${DB_PASSWORD:-Usr@SapaBBL2026!Qw7}
      - REDIS_HOST=${REDIS_HOST:-board-sapa-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - CACHE_DRIVER=${CACHE_DRIVER:-redis}
      - CACHE_PREFIX=${CACHE_PREFIX:-board_sapa}
      - SESSION_DRIVER=${SESSION_DRIVER:-redis}
      - SESSION_DOMAIN=${SESSION_DOMAIN:-.sapa-bbl.id}
      - LOG_CHANNEL=${LOG_CHANNEL:-stack}
      - LOG_LEVEL=${LOG_LEVEL:-error}
    depends_on:
      - redis
    networks:
      - dokploy-network
      - sapa-network

  nginx:
    image: nginx:1.27-alpine
    container_name: board-sapa-nginx
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - app-data:/var/www/html:ro
    depends_on:
      - app
    networks:
      - dokploy-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      # Service definition
      - "traefik.http.services.board-sapa.loadbalancer.server.port=80"
      # HTTPS Router - sapa-bbl.id (landing page)
      - "traefik.http.routers.board-sapa.rule=Host(`sapa-bbl.id`)"
      - "traefik.http.routers.board-sapa.entrypoints=websecure"
      - "traefik.http.routers.board-sapa.tls=true"
      - "traefik.http.routers.board-sapa.tls.certresolver=letsencrypt"
      - "traefik.http.routers.board-sapa.service=board-sapa"
      # HTTP Router with redirect
      - "traefik.http.routers.board-sapa-http.rule=Host(`sapa-bbl.id`)"
      - "traefik.http.routers.board-sapa-http.entrypoints=web"
      - "traefik.http.routers.board-sapa-http.middlewares=board-sapa-redirect-https"
      # Redirect middleware
      - "traefik.http.middlewares.board-sapa-redirect-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.board-sapa-redirect-https.redirectscheme.permanent=true"

  redis:
    image: redis:7-alpine
    container_name: board-sapa-redis
    volumes:
      - board-redis-data:/data
    networks:
      - sapa-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  sapa-network:
    external: true
    name: sapa-network
  dokploy-network:
    external: true
volumes:
  app-data:
  board-redis-data: